<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Review Website</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        header, footer {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 15px;
        }
        nav {
            display: flex;
            justify-content: center;
            background-color: #333;
            padding: 10px;
        }
        nav a {
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            margin: 0 10px;
        }
        nav a:hover {
            background-color: #ddd;
            color: black;
        }
        section {
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .home, .library, .movie-info, .add-review, .login, .register, .profile {
            display: none;
        }
        .active {
            display: block;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .gallery img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
        }
        .gallery img:hover {
            transform: scale(1.05);
            cursor: pointer;
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .button:hover {
            background-color: #45a049;
        }
        .cancel-button {
            color: #333;
            background-color: #ddd;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <h1>Welcome to the Movie Review Website</h1>
</header>

<nav>
    <a href="#" class="nav-link" data-target="home">Home</a>
    <a href="#" class="nav-link" data-target="library">Library</a>
    <a href="#" class="nav-link" data-target="login" id="login-link">Login</a>
    <a href="#" class="nav-link" data-target="register" id="register-link">Register</a>
    <a href="#" class="nav-link" id="logout-link" style="display: none;">Logout</a>
    <a href="#" class="nav-link" data-target="profile">Profile</a>
</nav>

<section class="container">
    <!-- Home Section -->
    <div class="home active">
        <h2>Home</h2>
        <p>Welcome to the homepage. Find movie reviews, top-rated films, or make an account to review movies yourself!</p>
    </div>

    <!-- Library Section -->
    <div class="library">
        <h2>Library</h2>
        <p>Explore our extensive movie library and find your next favorite film. Hover over each poster for details.</p>
        <div class="gallery">
            <img src="img/thematrix.jpeg" alt="Movie Poster 1" class="movie-image" data-movie="The Matrix" data-rating="4" data-description="A thrilling action-packed movie." data-poster="img/thematrix.jpeg">
            <img src="img/dune.jpeg" alt="Movie Poster 2" class="movie-image" data-movie="Dune" data-rating="5" data-description="An action-packed epic." data-poster="img/dune.jpeg">
            <img src="img/jaws.jpg" alt="Movie Poster 3" class="movie-image" data-movie="Jaws" data-rating="4.5" data-description="A classic thriller." data-poster="img/jaws.jpg">
        </div>
        <!-- Button and Field for Random Movie -->
        <p>Nothing catching your eye? Get Random Unlisted Movie!</p>
        <button id="random-movie-btn" class="button">Random Movie Generator</button>
        <p id="random-movie-display" style="margin-top: 15px; font-weight: bold;"></p>
    </div>
    <!-- Movie Info Section -->
    <div class="movie-info">
        <h2>Movie Info</h2>
        <div id="movie-details">
            <img id="movie-poster" src="" alt="Movie Poster">
            <h3 id="movie-title"></h3>
            <p id="movie-description"></p>
            <p class="rating" id="movie-rating"></p>
        </div>
        <button class="button" id="add-review-btn">Add Review</button>
        <div id="reviews-container">
            <h3>Reviews</h3>
        </div>
    </div>
    
    <!-- Add Review Section -->
    <div class="add-review">
        <h2>Add Review</h2>
        <form>
            <label for="movie">Movie Title:</label>
            <input type="text" id="movie" name="movie" placeholder="The Matrix"><br><br>
            <label for="rating">Your Rating (1-5):</label>
            <select id="rating" name="rating">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select><br><br>
            <label for="review">Your Review:</label><br>
            <textarea id="review" name="review" rows="4" cols="50"></textarea><br><br>
            <button type="submit">Submit Review</button>
            <button type="button" class="cancel-button" onclick="cancelReview()">Cancel</button>
        </form>
    </div>

    <!-- Login Section -->
    <div class="login">
        <h2>Login</h2>
        <form>
            <label for="username">Email:</label>
            <input type="email" id="username" name="username" required><br><br>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required><br><br>
            <button type="submit">Login</button>
        </form>
    </div>
    
    <div class="register">
        <h2>Register</h2>
        <form>
            <label for="reg-username">Username:</label>
            <input type="text" id="reg-username" name="reg-username" required><br><br>
            <label for="reg-email">Email:</label>
            <input type="email" id="reg-email" name="reg-email" required><br><br>
            <label for="reg-password">Password:</label>
            <input type="password" id="reg-password" name="reg-password" required><br><br>
            <label for="reg-confirm-password">Confirm Password:</label>
            <input type="password" id="reg-confirm-password" name="reg-confirm-password" required><br><br>
            <button type="submit">Register</button>
            <button type="button" onclick="cancelRegister()">Cancel</button>
        </form>
    </div>

    <!-- Profile Section -->
    <div class="profile">
        <h2>Your Profile</h2>
        <p id="profile-info">You need to log in to view your profile.</p>
        <h3>Your Reviews</h3>
        <div id="user-reviews-container"></div>
    </div>
</section>

<footer>
    <p>Movie Review Website &copy; 2024</p>
</footer>

<script defer>
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('section > div');
    const movieImages = document.querySelectorAll('.movie-image');
    const movieInfoSection = document.querySelector('.movie-info');
    const addReviewSection = document.querySelector('.add-review');
    const moviePoster = document.getElementById('movie-poster');
    const movieTitle = document.getElementById('movie-title');
    const movieDescription = document.getElementById('movie-description');
    const movieRating = document.getElementById('movie-rating');
    const movieTitleInput = document.getElementById('movie');
    const addReviewBtn = document.getElementById('add-review-btn');
    const reviewsContainer = document.getElementById('reviews-container');
    const loginLink = document.getElementById('login-link');
    const registerLink = document.getElementById('register-link');
    const logoutLink = document.getElementById('logout-link');


    navLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const target = this.dataset.target;
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.classList.contains(target)) {
                    section.classList.add('active');
                }
            });
            if (target === 'profile') loadUserProfile();
        });
    });

    async function registerUser(event) {
        event.preventDefault();
        const username = document.getElementById('reg-username').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const response = await fetch('http://localhost:5001/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password }),
        });
        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            document.querySelector('.register').classList.remove('active');
            document.querySelector('.login').classList.add('active');
        } else {
            alert(data.error);
        }
    }

    async function loginUser(event) {
        event.preventDefault();
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const response = await fetch('http://localhost:5001/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
        });
        const data = await response.json();
        if (response.ok) {
            localStorage.setItem('token', data.token);
            alert('Login successful');
            location.reload();
        } else {
            alert(data.error);
        }
    }

    async function loadUserProfile() {
    const token = localStorage.getItem('token');
    if (!token) {
        document.getElementById('profile-info').textContent = 'You need to log in to view your profile.';
        return;
    }

    try {
        const profileResponse = await fetch('http://localhost:5001/profile', {
            headers: { Authorization: token },
        });
        const profileData = await profileResponse.json();

        if (profileResponse.ok) {
            document.getElementById('profile-info').innerHTML = `
                <p>Username: ${profileData.username}</p>
                <p>Email: ${profileData.email}</p>
            `;
        } else {
            alert('You need to log in to access your profile.');
            return;
        }

        // Fetch and display user reviews
        await displayUserReviews();

    } catch (error) {
        console.error('Error loading profile:', error);
        alert('An error occurred while loading the profile.');
    }
}

async function displayUserReviews() {
    const token = localStorage.getItem('token'); // Retrieve token from localStorage
    const userReviewsContainer = document.getElementById('user-reviews-container');
    userReviewsContainer.innerHTML = ''; // Clear existing reviews

    if (!token) {
        userReviewsContainer.innerHTML = '<p>You need to log in to view your reviews.</p>';
        return;
    }

    try {
        const response = await fetch('http://localhost:5001/reviews/user', {
            headers: {
                Authorization: `Bearer ${token}`, // Send token in Authorization header
            },
        });

        if (!response.ok) {
            const errorData = await response.json();
            userReviewsContainer.innerHTML = `<p>Error: ${errorData.error || 'Unable to fetch reviews.'}</p>`;
            return;
        }

        const reviews = await response.json();

        if (reviews.length === 0) {
            userReviewsContainer.innerHTML = '<p>No reviews posted yet.</p>';
        } else {
            reviews.forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.classList.add('review');
                reviewElement.innerHTML = `
                    <h4>${review.movieTitle}</h4>
                    <p><strong>Rating:</strong> ${review.rating}/5</p>
                    <p>${review.reviewText}</p>
                    <p><small>Posted on ${new Date(review.createdAt).toLocaleDateString()}</small></p>
                `;
                userReviewsContainer.appendChild(reviewElement);
            });
        }
    } catch (error) {
        console.error('Error fetching user reviews:', error);
        userReviewsContainer.innerHTML = '<p>An error occurred while fetching reviews. Please try again later.</p>';
    }
}
function setupMovieClickListeners() {
    const movieImages = document.querySelectorAll('.movie-image'); 
    movieImages.forEach(img => {
        img.addEventListener('click', function () {
            const movieTitleText = this.dataset.movie;
            const movieRatingText = this.dataset.rating;
            const movieDescriptionText = this.dataset.description;
            const moviePosterSrc = this.dataset.poster;

            const moviePoster = document.getElementById('movie-poster');
            const movieTitle = document.getElementById('movie-title');
            const movieDescription = document.getElementById('movie-description');
            const movieRating = document.getElementById('movie-rating');

            moviePoster.src = moviePosterSrc;
            movieTitle.textContent = movieTitleText;
            movieDescription.textContent = movieDescriptionText;
            movieRating.textContent = `Rating: ${movieRatingText} / 5`;

            const sections = document.querySelectorAll('section > div');
            const movieInfoSection = document.querySelector('.movie-info');

            sections.forEach(section => section.classList.remove('active'));
            movieInfoSection.classList.add('active');

            displayReviews(movieTitleText);
        });
    });
}


function cancelReview() {
    const sections = document.querySelectorAll('section > div');
    const movieInfoSection = document.querySelector('.movie-info');
    sections.forEach(section => section.classList.remove('active'));
    movieInfoSection.classList.add('active');
}


async function submitReview(event) {
    event.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) return alert('You need to log in to submit a review.');

    const movieTitle = "The Matrix"; 
    const rating = document.getElementById('rating').value;
    const reviewText = document.getElementById('review').value;

    try {
        const response = await fetch('http://localhost:5001/reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`, 
            },
            body: JSON.stringify({ movieTitle, rating, reviewText }),
        });

        const data = await response.json();
        if (response.ok) {
            alert(data.message);
            document.querySelector('.add-review form').reset();

            // Navigate back to the movie info section
            const sections = document.querySelectorAll('section > div');
            sections.forEach(section => section.classList.remove('active'));
            document.querySelector('.movie-info').classList.add('active');

            // Refresh reviews for the movie
            displayReviews(movieTitle);
        } else {
            alert(data.error);
        }
    } catch (error) {
        console.error('Error submitting review:', error);
        alert('Failed to submit the review. Please try again later.');
    }
}

async function displayReviews(movieTitle) {
    const reviewsContainer = document.getElementById('reviews-container');
    reviewsContainer.innerHTML = ''; // Clear existing reviews

    try {
        const response = await fetch(`http://localhost:5001/reviews/movie/${movieTitle}`);
        const reviews = await response.json();

        if (reviews.length === 0) {
            reviewsContainer.innerHTML = '<p>No reviews yet. Be the first to review!</p>';
            return;
        }

        reviews.forEach(review => {
            const reviewElement = document.createElement('div');
            reviewElement.classList.add('review');
            reviewElement.innerHTML = `
                <p><strong>${review.username}</strong> rated ${review.rating}/5</p>
                <p>${review.reviewText}</p>
                <p><small>Posted on ${new Date(review.createdAt).toLocaleDateString()}</small></p>
            `;
            reviewsContainer.appendChild(reviewElement);
        });
    } catch (error) {
        console.error('Error fetching movie reviews:', error);
        reviewsContainer.innerHTML = '<p>An error occurred while fetching reviews. Please try again later.</p>';
    }
}

function checkLoginStatus() {
    const token = localStorage.getItem('token');
    const loginLink = document.getElementById('login-link');
    const registerLink = document.getElementById('register-link');
    const logoutLink = document.getElementById('logout-link');

    if (token) {
        // User is logged in
        loginLink.style.display = 'none';
        registerLink.style.display = 'none';
        logoutLink.style.display = 'block';
    } else {
        // User is logged out
        loginLink.style.display = 'block';
        registerLink.style.display = 'block';
        logoutLink.style.display = 'none';
    }

    // Remove old event listeners and add a new one for logout
    logoutLink.replaceWith(logoutLink.cloneNode(true));
    const updatedLogoutLink = document.getElementById('logout-link');
    updatedLogoutLink.addEventListener('click', (event) => {
        event.preventDefault();
        localStorage.removeItem('token'); // Remove token
        alert('Logged out successfully.');
        checkLoginStatus(); // Update UI
        location.reload(); // Reload page (optional)
    });
}
document.addEventListener('DOMContentLoaded', () => {
    checkLoginStatus();
    setupMovieClickListeners();

    // Register form handlers
    document.querySelector('.add-review form').addEventListener('submit', submitReview);
    document.querySelector('.register form').addEventListener('submit', registerUser);
    document.querySelector('.login form').addEventListener('submit', loginUser);

    // Add Review Button Handler
    addReviewBtn.addEventListener('click', (event) => {
        event.preventDefault();
        navigateToAddReview();
    });
});
function navigateToAddReview() {
    // Activate the Add Review section
    sections.forEach(section => section.classList.remove('active'));
    addReviewSection.classList.add('active');

    // Populate the movie title input field (if needed)
    const movieTitle = movieTitle.textContent;
    movieTitleInput.value = movieTitle;

    // Clear the form fields to avoid residual data
    document.querySelector('.add-review form').reset();
}

async function getMovieDetailsByPoster(posterName) {
    try {
        const response = await fetch(`http://localhost:5005/movie-by-poster/${posterName}`);
        if (!response.ok) {
            throw new Error('Movie not found');
        }
        const movie = await response.json();
        return movie.title; // Return the movie title
    } catch (error) {
        console.error('Error fetching movie details:', error);
        return 'Unknown Movie';
    }
}
document.querySelectorAll('.movie-image').forEach(img => {
    img.addEventListener('click', () => {
        const poster = img.getAttribute('data-poster');
        document.getElementById('movie-poster').value = poster;
    });
});

document.getElementById('random-movie-btn').addEventListener('click', async () => {
    const randomMovieDisplay = document.getElementById('random-movie-display');
    randomMovieDisplay.textContent = 'Fetching a random movie...';

    try {
        const response = await fetch('http://localhost:5001/random-movie');
        const data = await response.json();
        randomMovieDisplay.textContent = `Random Movie: ${data.movie}`;
    } catch (error) {
        console.error('Error fetching random movie:', error);
        randomMovieDisplay.textContent = 'Failed to fetch random movie. Please try again.';
    }
});



</script>

</body>
</html>